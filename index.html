<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Class Positives and Negatives</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --bg-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --bg-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --bg-success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    --bg-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --card: rgba(255,255,255,.95);
    --card-glass: rgba(255,255,255,.1);
    --text: #1a202c; --text-light:#4a5568; --text-muted:#718096;
    --border: rgba(255,255,255,.2);
    --shadow-sm: 0 4px 6px rgba(0,0,0,.05);
    --shadow-md: 0 10px 25px rgba(0,0,0,.1);
    --shadow-lg: 0 20px 40px rgba(0,0,0,.15);
    --radius: 20px; --radius-sm:12px; --radius-lg:28px;
    --purple-neutral:#6c63d9; /* roxo neutro do degradê */
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;overflow-x:hidden}
  body{
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
    background:var(--bg-primary);
    color:var(--text); line-height:1.6; position:relative;
  }

  /* brilhos leves ao fundo */
  body::before{
    content:''; position:fixed; inset:0; pointer-events:none; z-index:-2;
    background:
      radial-gradient(circle at 20% 20%, rgba(120,119,198,.28) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255,119,198,.28) 0%, transparent 50%),
      radial-gradient(circle at 40% 40%, rgba(79,172,254,.18) 0%, transparent 50%);
  }
  /* fundo discretíssimo com emojis ⭐ */
  body::after{
    content:''; position:fixed; inset:0; pointer-events:none; z-index:-1;
    opacity:.40;
    background-image:
      url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="420" height="420">\
  <rect width="420" height="420" fill="none"/>\
  <text x="60"  y="80"  font-size="22">⭐</text>\
  <text x="330" y="140" font-size="18">⭐</text>\
  <text x="210" y="260" font-size="20">⭐</text>\
</svg>'),
      url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="520" height="520">\
  <rect width="520" height="520" fill="none"/>\
  <text x="120" y="70"  font-size="18">⭐</text>\
  <text x="380" y="220" font-size="22">⭐</text>\
  <text x="260" y="420" font-size="16">⭐</text>\
</svg>');
    background-repeat: repeat, repeat;
    background-size: 420px 420px, 520px 520px;
    background-position: 0 0, 160px 190px;
  }

  .container{max-width:1200px;margin:0 auto;padding:20px}

/* === HEADER: banner em cima, abas embaixo, tudo centralizado === */
header{
  display:flex;
  flex-direction:column;     /* empilha */
  align-items:center;
  justify-content:center;
  gap:16px;
  margin-bottom:30px;
}
  /* Banner preenche a coluna e fica centralizado */
.brand{
  width:100%;
  max-width: 960px;          /* ajuste se quiser maior/menor */
  justify-content:center;    /* centraliza foguete+textos dentro do banner */
}
/* Foguete maior (proporcional aos títulos) */
.logo{
  width:72px;
  height:72px;
  font-size:36px;
}
  /* textos do banner centralizados */
  .title{
    flex:1;
    display:flex; flex-direction:column;
    align-items:center;
    text-align:center;
  }
  .title-line{
    display:inline-flex;
    align-items:baseline;
    justify-content:center;
    gap:10px; flex-wrap:wrap;
  }
  .title-main{
    font-size:clamp(28px,4.4vw,36px);
    font-weight:900; letter-spacing:-.3px;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .title-sep{
    color:var(--purple-neutral);
    font-weight:900;
    font-size:clamp(16px,2.2vw,18px); /* “•” roxo */
    line-height:1;
  }
  .title-sub{
    font-size:clamp(18px,2.4vw,22px);
    font-weight:900;
    color:var(--purple-neutral);
  }
  .title-credit{
    margin-top:6px;
    font-size:clamp(12px,1.6vw,14px);
    font-weight:800; letter-spacing:.2px;
    color:var(--purple-neutral);
  }

 /* Abas logo abaixo e centralizadas */
.tabs-top{
  margin:0 auto;             /* centraliza o container das abas */
  justify-self:auto;         /* anula alinhamento antigo do grid */
}

  .tab-btn{
    font:inherit; border:none; border-radius:12px; padding:6px 10px; cursor:pointer;
    background:var(--card); display:inline-flex; align-items:center; gap:8px;
    font-size:12px; font-weight:700; box-shadow:var(--shadow-sm)
  }
  .tab-btn[aria-selected="true"]{background:var(--bg-primary);color:#fff}

  /* Cards e demais estilos existentes */
  .card{background:var(--card);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);padding:24px; backdrop-filter:blur(20px);border:1px solid var(--border);position:relative;overflow:hidden}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--bg-primary);border-radius:var(--radius-lg) var(--radius-lg) 0 0}

  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
  .col{flex:1 1 300px}
  .control{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* compacto global */
  input, select{
    font: inherit; border:2px solid rgba(255,255,255,.3); border-radius:12px;
    padding:8px 10px; background:rgba(255,255,255,.9); box-shadow:var(--shadow-sm); font-size:13px;
  }
  input[type="number"]{width:90px}
  .btn{font:inherit;border-radius:12px;padding:6px 10px;border:none;background:var(--card);cursor:pointer; font-weight:700;box-shadow:var(--shadow-sm);font-size:12px}
  .btn-primary{background:var(--bg-primary);color:#fff}
  .btn-danger{background:var(--bg-warning);color:#fff}

  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:rgba(255,255,255,.9);border:1px solid rgba(255,255,255,.3);padding:6px 10px;border-radius:18px;color:#334155;font-size:12px;font-weight:700}

  .rowcard{display:grid;gap:10px;align-items:center;grid-template-columns:1fr 100px 110px 64px 64px auto; padding:12px;border:1px solid rgba(255,255,255,.3);border-radius:14px;background:rgba(255,255,255,.95);margin-bottom:10px}
  .rowcard.view{grid-template-columns:1fr repeat(3,110px) auto}
  .name{font-weight:800;font-size:15px}
  .mini{font-size:12px;color:#64748b;font-weight:700}

  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:12px 0}
  .tab{padding:8px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.9);cursor:pointer;font-size:12px;font-weight:800}
  .tab.active{background:var(--bg-primary);color:#fff}

  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin:16px 0}
  th,td{padding:12px 16px;background:rgba(255,255,255,.95);border:1px solid rgba(255,255,255,.3);font-size:13px}
  th{background:var(--bg-primary);color:#fff;text-align:left;font-weight:900}
  tr:hover td{background:#fff;transform:scale(1.01)}
  tr td:first-child, tr th:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
  tr td:last-child,  tr th:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
  .empty{color:#64748b;border:2px dashed rgba(255,255,255,.5);padding:24px;border-radius:14px;background:rgba(255,255,255,.7);text-align:center;font-weight:800}

  .progress{height:18px;background:rgba(255,255,255,.3);border-radius:10px;position:relative;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.1)}
  .progress .bar{height:100%;border-radius:10px;transition:width .8s cubic-bezier(.4,0,.2,1)}
  .progress.bad .bar{background:linear-gradient(135deg,#ff6b9d 0%,#f093fb 100%)}
  .progress.ok  .bar{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%)}
  .progress.good .bar{background:var(--bg-success)}
  .progress .label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;font-weight:900;color:#1f2937}

  .pill{padding:6px 14px;border-radius:20px;font-weight:800;display:inline-block;font-size:12px;box-shadow:var(--shadow-sm)}
  .pill.neg{background:linear-gradient(135deg,#ff6b9d 0%,#f093fb 100%);color:#fff}
  .pill.pos{background:var(--bg-success);color:#fff}
  .pill.total{background:var(--bg-accent);color:#fff}

  .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);margin:18px 0}
  .hidden{display:none !important}

  @media (max-width: 840px){
    header{ grid-template-columns: 1fr; }
    .tabs-top{ justify-self:center; }
  }

/* REGRAS: centralizar cabeçalhos "Positivo" e "Negativo" */
#rulesSection thead th{
  text-align:center;
}
/* === FIXES DO BANNER E NAV === */

/* Header: empilha e centraliza (banner em cima, abas embaixo) */
header{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  gap:16px !important;
}

/* Banner branco (cartão) reaparece e centraliza o conteúdo */
.brand{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  gap:18px !important;

  /* cartão branco */
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 24px !important;
  box-shadow: var(--shadow-lg) !important;
  padding: 22px 28px !important;

  max-width: 980px !important;
  width: 100% !important;
}

/* Foguete 50% maior (antes ~52px) */
.logo{
  width: 78px !important;
  height: 78px !important;
  border-radius: 16px !important;
  display:grid !important;
  place-items:center !important;
  background: linear-gradient(135deg,#667eea 0%, #764ba2 100%) !important;
  color:#fff !important;
  font-size: 42px !important;  /* 50% maior vs ~28px */
  line-height: 1 !important;
}

/* Tipografia centralizada no banner */
.title{ text-align:center !important; }
.title-line{
  display:flex !important;
  align-items:baseline !important;
  justify-content:center !important;
  gap:10px !important;
  flex-wrap:wrap !important;
}

/* Tamanhos harmônicos com o foguete maior */
.title-main{
  font-size: clamp(34px, 5vw, 46px) !important;
  font-weight: 900 !important;
  letter-spacing: -0.3px !important;
  background: linear-gradient(135deg,#667eea 0%, #764ba2 100%) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  background-clip: text !important;
}
.title-bullet{ color: var(--purple-neutral) !important; font-weight:900 !important; }
.title-sub-dark{
  color: var(--purple-neutral) !important;
  font-weight: 900 !important;
  font-size: clamp(18px, 2.6vw, 24px) !important;
}
.title-credit{
  margin-top: 6px !important;
  color: var(--purple-neutral) !important;
  font-weight: 800 !important;
  font-size: clamp(12px, 1.6vw, 14px) !important;
}

/* Abas logo abaixo, centralizadas */
.tabs-top{
  margin: 0 auto !important;
}

</style>
</head>
<body>
<div class="container">
  <header>
    <!-- Banner -->
    <div class="brand" aria-label="Marca do site">
      <div class="logo">🚀</div>
      <div class="title" role="heading" aria-level="1">
        <div class="title-line">
          <span class="title-main">English Class</span>
          <span class="title-sep">•</span>
          <span class="title-sub">Positives and Negatives</span>
        </div>
        <div class="title-credit">By Teacher Pâmela</div>
      </div>
    </div>

    <!-- Abas -->
    <nav class="tabs-top" role="tablist" aria-label="Navegação principal">
      <button class="tab-btn" role="tab" data-target="rulesSection" aria-selected="true">📜 Regras</button>
      <button class="tab-btn" role="tab" data-target="studentSection" aria-selected="false">🧑‍🎓 Portal do Aluno</button>
      <button class="tab-btn" role="tab" data-target="viewSection" aria-selected="false">📚 Turmas</button>
      <button class="tab-btn" role="tab" data-target="reportsSection" aria-selected="false">📊 Relatórios</button>
      <button class="tab-btn" role="tab" data-target="adminSection" aria-selected="false">🛠️ Admin</button>
    </nav>
  </header>

  <!-- REGRAS -->
  <section id="rulesSection" class="card">
    <div class="chips">
      <span class="chip">Sem negativos no dia: <b>+3 positivos de bônus</b></span>
      <span class="chip">Negativos são descontados dos positivos</span>
      <span class="chip">Se faltar, nada é contabilizado</span>
    </div>
    <table>
      <thead><tr><th>Positivo</th><th>Negativo</th></tr></thead>
      <tbody>
        <tr><td>Manter silêncio durante a explicação.</td><td>Conversar fora de hora.</td></tr>
        <tr><td>Começar a atividade imediatamente após a instrução.</td><td>Não começar a atividade no tempo determinado.</td></tr>
        <tr><td>Permanecer no lugar durante a atividade.</td><td>Levantar-se sem autorização.</td></tr>
        <tr><td>Esperar a vez para falar.</td><td>Interromper colega ou professora.</td></tr>
        <tr><td>Trazer todo o material para a aula.</td><td>Não trazer material necessário.</td></tr>
        <tr><td>Ajudar colega de forma produtiva.</td><td>Brincar ou distrair outros.</td></tr>
        <tr><td>Seguir instruções na primeira vez que são dadas.</td><td>Não seguir instruções dadas.</td></tr>
        <tr><td>Cuidar de seus próprios assuntos.</td><td>Se intrometer em assuntos da professora ou colegas.</td></tr>
        <tr><td>Entregar tarefa/trabalho completo e caprichado.</td><td>Entregar tarefa/trabalho incompleto, malfeito ou não entregar.</td></tr>
        <tr><td>Demonstrar respeito e cortesia com todos.</td><td>Desrespeitar regras de convivência.</td></tr>
      </tbody>
    </table>
  </section>

  <!-- PORTAL DO ALUNO -->
  <section id="studentSection" class="card hidden" aria-hidden="true">
    <div class="row"><div class="col">
      <div class="control">
        <input id="studentClassCode" placeholder="Código da Turma (ex.: 3B)" />
        <input id="studentName" placeholder="Seu nome (igual ao cadastrado)" />
        <button class="btn btn-primary" id="btnLoadStudent">Ver meu relatório</button>
      </div>
    </div></div>
    <div class="hr"></div>
    <div id="studentWrap" class="hidden">
      <div class="row">
        <div class="col">
          <div class="chips">
            <span class="chip">Aluno: <b id="stName"></b></span>
            <span class="chip">Turma: <b id="stClass"></b></span>
          </div>
        </div>
        <div class="col">
          <div class="control" style="width:100%">
            <div style="flex:1">
              <div class="mini" style="margin-bottom:6px">Progresso acumulado</div>
              <div id="stProgress" class="progress"><div class="bar" style="width:0%"></div><div class="label">0%</div></div>
            </div>
            <div style="min-width:120px;text-align:center">
              <div class="mini">Tendência</div>
              <div id="stTrend" class="chip" style="display:inline-block;margin-top:4px">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="mini" style="margin-bottom:8px">Datas avaliadas</div>
      <div id="stDateTabs" class="tabs"></div>
      <div id="stDailyWrap" class="hidden">
        <div class="chips" id="stDailyChips"></div>
        <table>
          <thead><tr><th>Dia</th><th>Negativos</th><th>Positivos</th><th>Faltou?</th><th>% do dia</th></tr></thead>
          <tbody id="stDailyBody"></tbody>
        </table>
      </div>
      <div id="stEmpty" class="empty hidden">Nenhuma data lançada para este aluno ainda.</div>
    </div>
  </section>

  <!-- TURMAS -->
  <section id="viewSection" class="card hidden" aria-hidden="true">
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <div class="control">
          <input id="viewClassCode" placeholder="Código da Turma (ex.: 3B)" />
          <button class="btn btn-primary" id="btnLoadView">Carregar</button>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div id="viewClassWrap" class="hidden">
      <div class="chips" style="margin-bottom:8px">
        <span class="chip">Turma: <b id="viewClassName"></b></span>
        <span class="chip">Alunos: <b id="viewCount"></b></span>
      </div>
      <div class="tabs" id="viewSortTabs">
        <button class="tab active" data-sort="az">A–Z</button>
        <button class="tab" data-sort="pos">Mais Positivos</button>
        <button class="tab" data-sort="apr">Maior Aproveitamento</button>
      </div>
      <div id="viewList"></div>
    </div>
  </section>

  <!-- RELATÓRIOS -->
  <section id="reportsSection" class="card hidden" aria-hidden="true">
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <div class="control">
          <input id="reportClassCode" placeholder="Código da Turma (ex.: 3B)" />
          <button class="btn btn-primary" id="btnLoadReport">Carregar</button>
        </div>
      </div>
      <div class="col">
        <div class="tabs">
          <button class="tab active" id="tabDaily">Por dia</button>
          <button class="tab" id="tabAccum">Acumulado</button>
        </div>
      </div>
    </div>
    <div id="dailyPane">
      <div id="dateTabs" class="tabs"></div>
      <div class="chips" id="dailyChips"></div>
      <div id="dailyTableWrap">
        <table id="dailyTable">
          <thead><tr><th>Aluno</th><th>Negativos (dia)</th><th>Positivos (dia)</th><th>Faltou?</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="dailyEmpty" class="empty hidden">Nenhuma data avaliada ainda para esta turma.</div>
      </div>
      <div class="control" style="margin-top:8px">
        <button id="btnExportDaily" class="btn">⬇️ Exportar CSV (dia)</button>
      </div>
    </div>
    <div id="accumPane" class="hidden">
      <div class="chips"><span class="chip">Aproveitamento = max(0, (Pos − Neg) / Pos) × 100</span></div>
      <table id="accumTable">
        <thead><tr><th>Aluno</th><th>Negativos (total)</th><th>Positivos (total)</th><th>Aproveitamento</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="control" style="margin-top:8px">
        <button id="btnExportAccum" class="btn">⬇️ Exportar CSV (acumulado)</button>
      </div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="adminSection" class="card hidden" aria-hidden="true">
    <div id="loginBox">
      <div class="row"><div class="col">
        <div class="control">
          <input id="adminPassword" type="password" placeholder="Senha" />
          <button class="btn btn-primary" id="btnLogin">Entrar</button>
        </div>
        <div class="mini" style="margin-top:6px">Use Exportar/Importar para backup.</div>
      </div></div>
    </div>

    <div id="adminBox" class="hidden">
      <div class="row">
        <div class="col">
          <div class="mini">Turma</div>
          <div class="control">
            <select id="classSelect"></select>
            <button class="btn" id="btnNewClass">+ Nova turma</button>
            <button class="btn" id="btnEditClass">✏️ Editar turma</button>
            <button class="btn btn-danger" id="btnDeleteClass">Excluir turma</button>
          </div>
        </div>
        <div class="col">
          <div class="mini">Novo aluno</div>
          <div class="control">
            <input id="newStudentName" placeholder="Nome do aluno" />
            <button class="btn" id="btnAddStudent">+ Adicionar</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="align-items:flex-end">
        <div class="col">
          <div class="mini">Data do dia</div>
          <input id="sessionDate" type="date" />
        </div>
        <div class="col">
          <div class="mini">Positivos avaliados (padrão 8)</div>
          <input id="evaluatedPos" type="number" min="0" step="1" value="8" />
        </div>
        <div class="col">
          <div class="control">
            <button class="btn" id="btnZeros">Zerar campos do dia</button>
            <button class="btn btn-primary" id="btnSaveDay">💾 Salvar Dia</button>
          </div>
        </div>
        <div class="col">
          <div class="control">
            <button class="btn" id="btnExport">⬇️ Exportar JSON</button>
            <input id="importFile" type="file" accept="application/json" class="hidden" />
            <button class="btn" id="btnImport">⬆️ Importar JSON</button>
            <button class="btn btn-danger" id="btnReset">🧹 Reset</button>
          </div>
        </div>
      </div>

      <div class="mini" style="margin:10px 0">Marque <b>Faltou</b> quando o aluno não assistiu (nada é aplicado no dia).</div>
      <div id="editList" style="margin-top:6px"></div>
    </div>
  </section>
</div>

<script>
/* ===== Estado base ===== */
const STORAGE_KEY='ec_points_v1';
const PRELOADED_STATE={ adminPassword:'051024', classes:{} };

function loadState(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(PRELOADED_STATE)); return PRELOADED_STATE; }
  try{ return JSON.parse(raw);}catch(e){ alert('Dados corrompidos. Iniciando do zero.'); localStorage.removeItem(STORAGE_KEY); return loadState(); }
}
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

let state=loadState();
let isAuthed=false;
let currentViewCode='';
let currentSelectedReportDate='';
let currentViewSort='az';

const $=s=>document.querySelector(s);
const $$=s=>Array.prototype.slice.call(document.querySelectorAll(s));
function todayISO(){return new Date().toISOString().slice(0,10);}
function n(x){return Number(x||0);}
function computeAproveitamento(pos,neg){ if(pos<=0) return 0; const p=((pos-neg)/pos)*100; return Math.max(0,Math.min(100,p)); }

/* ===== Abas topo ===== */
function setActiveSection(sectionId){
  const sections = ['rulesSection','studentSection','viewSection','reportsSection','adminSection'];
  if(sections.indexOf(sectionId)===-1) sectionId='rulesSection';
  sections.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(id===sectionId){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    else{ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
  });
  $$('.tab-btn').forEach(btn=>{
    btn.setAttribute('aria-selected', btn.getAttribute('data-target')===sectionId ? 'true' : 'false');
  });
}
function initTopTabs(){
  $$('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const target=this.getAttribute('data-target'); if(!target) return;
      setActiveSection(target);
      try{ history.replaceState(null,'','#'+target); }catch(_){}
    }, false);
  });
  const initial = (location.hash||'').replace('#','') || 'rulesSection';
  setActiveSection(initial);
  window.addEventListener('hashchange', function(){
    const id=(location.hash||'').replace('#','')||'rulesSection';
    setActiveSection(id);
  });
}

/* ===== Turmas (view) ===== */
function renderViewList(cls){
  const wrap=$('#viewList'); wrap.innerHTML='';
  var items = Object.keys(cls.students||{}).map(function(name){
    var data=cls.students[name]||{}; var neg=n((data.totals||{}).neg); var pos=n((data.totals||{}).pos);
    var apr=computeAproveitamento(pos,neg); return {name:name,neg:neg,pos:pos,apr:apr,total:pos-neg};
  });
  if(currentViewSort==='az') items.sort(function(a,b){return a.name.localeCompare(b.name,'pt-BR');});
  if(currentViewSort==='pos') items.sort(function(a,b){return (b.pos-a.pos)||a.name.localeCompare(b.name,'pt-BR');});
  if(currentViewSort==='apr') items.sort(function(a,b){return (b.apr-a.apr)||a.name.localeCompare(b.name,'pt-BR');});
  $('#viewCount').textContent=items.length;
  items.forEach(function(it, idx){
    var rank = (currentViewSort==='az')?'':('<span class="mini" style="color:#475569">#'+(idx+1)+'</span>');
    var row=document.createElement('div'); row.className='rowcard view';
    row.innerHTML='<div class="name">📘 '+it.name+' '+rank+'</div>'
                 +'<div class="pill neg">-'+it.neg+'</div>'
                 +'<div class="pill pos">+'+it.pos+'</div>'
                 +'<div class="pill total">'+it.total+'</div>'
                 +'<div style="justify-self:end"><div class="mini">Aprov.: <b>'+Math.round(it.apr)+'%</b></div></div>';
    wrap.appendChild(row);
  });
}
function attachViewSortTabs(){
  var tabs = $('#viewSortTabs'); if(!tabs) return;
  [].forEach.call(tabs.querySelectorAll('.tab'), function(btn){
    btn.addEventListener('click', function(){
      [].forEach.call(tabs.querySelectorAll('.tab'), function(b){ b.classList.remove('active'); });
      this.classList.add('active'); currentViewSort=this.getAttribute('data-sort');
      var code=currentViewCode; if(code && state.classes[code]) renderViewList(state.classes[code]);
    });
  });
}
$('#btnLoadView').addEventListener('click', function(){
  var code=$('#viewClassCode').value.trim(); if(!code) return;
  var cls=state.classes[code]; if(!cls){ alert('Turma não encontrada.'); return; }
  currentViewCode=code; $('#viewClassName').textContent=cls.name||cls.code;
  $('#viewClassWrap').classList.remove('hidden'); renderViewList(cls); attachViewSortTabs();
});

/* ===== Admin ===== */
function renderEditList(cls){
  var wrap=$('#editList'); if(!wrap) return; wrap.innerHTML='';
  var students=Object.keys(cls.students||{}).sort(function(a,b){return a.localeCompare(b,'pt-BR');});
  students.forEach(function(name){
    var data=cls.students[name]||{}; var totalNeg=n((data.totals||{}).neg); var totalPos=n((data.totals||{}).pos);
    var row=document.createElement('div'); row.className='rowcard'; row.setAttribute('data-name',name);
    row.innerHTML=
      '<div><div class="name">🧩 '+name+'</div><div class="mini">Faltou? <input type="checkbox" class="absent" /></div></div>'
     +'<input type="number" min="0" step="1" class="negToday" placeholder="Negativos" />'
     +'<input type="number" min="0" step="1" class="posExtra" placeholder="Positivos" />'
     +'<div class="pill neg">-'+totalNeg+'</div>'
     +'<div class="pill pos">+'+totalPos+'</div>'
     +'<div class="control" style="justify-self:end">'
     +  '<button class="btn mini btnMinus">+1 neg</button>'
     +  '<button class="btn mini btnPlus">+1 pos</button>'
     +  '<button class="btn btn-danger mini btnRemove">Excluir</button>'
     +'</div>';
    row.querySelector('.btnPlus').onclick=function(){ var i=row.querySelector('.posExtra'); i.value=n(i.value)+1; };
    row.querySelector('.btnMinus').onclick=function(){ var i=row.querySelector('.negToday'); i.value=n(i.value)+1; };
    row.querySelector('.btnRemove').onclick=function(){
      if(confirm('Remover aluno "'+name+'"?')){ delete cls.students[name]; saveState(state); renderEditList(cls); if(currentViewCode===cls.code) renderViewList(cls); }
    };
    wrap.appendChild(row);
  });
}
$('#btnLogin').addEventListener('click', function(){
  var pass=$('#adminPassword').value;
  if(pass === (state.adminPassword||'051024')){
    isAuthed=true; $('#loginBox').classList.add('hidden'); $('#adminBox').classList.remove('hidden');
    populateClassSelect(); if(!$('#sessionDate').value) $('#sessionDate').value=todayISO();
    var code=$('#classSelect').value; if(code){ renderEditList(state.classes[code]); if(currentViewCode===code) renderViewList(state.classes[code]); }
  } else alert('Senha incorreta.');
});
function populateClassSelect(){
  var sel=$('#classSelect'); if(!sel) return; sel.innerHTML='';
  Object.keys(state.classes||{}).sort(function(a,b){return a.localeCompare(b,'pt-BR');}).forEach(function(code){
    var c=state.classes[code]; var opt=document.createElement('option');
    opt.value=c.code; opt.textContent=c.code+' — '+(c.name||c.code); sel.appendChild(opt);
  });
}
$('#classSelect').addEventListener('change', function(e){
  var code=e.target.value; var cls=state.classes[code]; if(cls){ renderEditList(cls); if(currentViewCode===code) renderViewList(cls); }
});
$('#btnNewClass').addEventListener('click', function(){
  var code=prompt('Código da turma (ex.: 3A):'); if(!code) return;
  if(state.classes[code]) return alert('Já existe.');
  var name=prompt('Nome da turma (visível aos alunos):', code);
  state.classes[code]={name:name, code:code, students:{}}; saveState(state);
  populateClassSelect(); $('#classSelect').value=code; renderEditList(state.classes[code]);
});
$('#btnEditClass').addEventListener('click', function(){
  var old=$('#classSelect').value; if(!old) return alert('Selecione uma turma.');
  var cls=state.classes[old]; var newCode=prompt('Novo código da turma:', cls.code); if(!newCode) return;
  var newName=prompt('Novo nome da turma (visível aos alunos):', cls.name||cls.code) || cls.name||cls.code;
  if(newCode!==old && state.classes[newCode]) return alert('Já existe uma turma com esse código.');
  delete state.classes[old]; cls.code=newCode; cls.name=newName; state.classes[newCode]=cls; saveState(state);
  populateClassSelect(); $('#classSelect').value=newCode; renderEditList(cls); if(currentViewCode===old){ currentViewCode=newCode; renderViewList(cls); }
});
$('#btnDeleteClass').addEventListener('click', function(){
  var code=$('#classSelect').value; if(!code) return; if(!confirm('Excluir turma "'+code+'"?')) return;
  delete state.classes[code]; saveState(state); populateClassSelect(); $('#editList').innerHTML=''; if(currentViewCode===code){ $('#viewList').innerHTML=''; $('#viewClassWrap').classList.add('hidden'); currentViewCode=''; }
});
$('#btnAddStudent').addEventListener('click', function(){
  var code=$('#classSelect').value; if(!code) return alert('Selecione uma turma.');
  var name=$('#newStudentName').value.trim(); if(!name) return; var cls=state.classes[code]; if(cls.students[name]) return alert('Aluno já existe.');
  cls.students[name]={totals:{neg:0,pos:0}, history:[]}; $('#newStudentName').value=''; saveState(state); renderEditList(cls); if(currentViewCode===code) renderViewList(cls);
});

function applySaveDay(){
  var code=$('#classSelect').value; var cls=state.classes[code]; if(!cls) return alert('Selecione uma turma.');
  var date=$('#sessionDate').value||todayISO(); var evaluated=n($('#evaluatedPos').value||8);
  [].forEach.call(document.querySelectorAll('#editList .rowcard'), function(row){
    var name=row.getAttribute('data-name'); var s=cls.students[name]; if(!s) return;
    var absent=row.querySelector('.absent').checked;
    var negToday=n(row.querySelector('.negToday').value);
    var posExtra=n(row.querySelector('.posExtra').value);
    if(absent){ s.history=s.history||[]; s.history.push({date:date, absent:true}); row.querySelector('.negToday').value=''; row.querySelector('.posExtra').value=''; return; }
    var baseApplied=Math.max(0, evaluated - negToday);
    var consistency=negToday===0?3:0;
    var posAdded=baseApplied + posExtra + consistency;
    s.totals=s.totals||{neg:0,pos:0}; s.totals.pos=n(s.totals.pos)+posAdded; s.totals.neg=n(s.totals.neg)+negToday;
    s.history=s.history||[]; s.history.push({date:date, neg:negToday, posExtra:posExtra, evaluated:evaluated, applied:{baseApplied:baseApplied, consistency:consistency, posAdded:posAdded}});
    row.querySelector('.negToday').value=''; row.querySelector('.posExtra').value='';
  });
  saveState(state);
  renderEditList(cls); if(currentViewCode===code) renderViewList(cls);
  if(!$('#reportsSection').classList.contains('hidden')){ renderDateTabs(code); renderAccumReport(code); }
  alert('Dia salvo para '+code+' em '+date+'.');
}
$('#btnSaveDay').addEventListener('click', applySaveDay);
$('#btnZeros').addEventListener('click', function(){ $$('.negToday,.posExtra,.absent').forEach(function(i){ if(i.type==='checkbox') i.checked=false; else i.value=''; }); });
$('#btnExport').addEventListener('click', function(){
  var data=JSON.stringify(state,null,2); var blob=new Blob([data],{type:'application/json'}); var url=URL.createObjectURL(blob);
  var a=document.createElement('a'); a.href=url; a.download='english-class.json'; a.click(); URL.revokeObjectURL(url);
});
$('#btnImport').addEventListener('click', function(){ $('#importFile').click(); });
$('#importFile').addEventListener('change', function(e){
  var file=e.target.files[0]; if(!file) return; var reader=new FileReader();
  reader.onload=function(){ try{
    var json=JSON.parse(reader.result); if(!json || !json.classes) throw new Error('Arquivo inválido.');
    state=json; saveState(state); populateClassSelect(); var code=$('#classSelect').value; if(code){ renderEditList(state.classes[code]); if(currentViewCode===code) renderViewList(state.classes[code]); } alert('Importado com sucesso!');
  }catch(err){ alert('Falha ao importar: '+err.message); } };
  reader.readAsText(file);
});
$('#btnReset').addEventListener('click', function(){
  if(!confirm('Apagar TUDO deste navegador e restaurar padrão (vazio)?')) return;
  localStorage.removeItem(STORAGE_KEY); state=PRELOADED_STATE; saveState(state);
  populateClassSelect(); $('#editList').innerHTML=''; $('#viewList').innerHTML=''; $('#viewClassWrap').classList.add('hidden'); currentViewCode='';
  alert('Tudo limpo.');
});

/* ===== Relatórios ===== */
function buildDailyMap(cls){
  var map={}; Object.keys(cls.students||{}).forEach(function(name){
    var s=cls.students[name]||{}; (s.history||[]).forEach(function(h){
      var d=h.date; if(!d) return; if(!map[d]) map[d]={byStudent:{}, totals:{neg:0,pos:0,absentCount:0}};
      var ent=map[d].byStudent[name] || {neg:0,pos:0,absent:false};
      if(h.absent){ ent.absent=true; map[d].totals.absentCount++; }
      if(typeof h.neg==='number'){ ent.neg+=h.neg; map[d].totals.neg+=h.neg; }
      var posAdded=(h.applied&&h.applied.posAdded)||0; if(posAdded){ ent.pos+=posAdded; map[d].totals.pos+=posAdded; }
      map[d].byStudent[name]=ent;
    });
  }); return map;
}
function formatDateLabel(iso){ if(!iso) return ''; var p=iso.split('-'); return p[2]+'/'+p[1]; }
function renderDateTabs(code){
  var cls=state.classes[code]; if(!cls) return;
  var map=buildDailyMap(cls); var dates=Object.keys(map).sort(function(a,b){return b.localeCompare(a);});
  var tabs=$('#dateTabs'); tabs.innerHTML='';
  if(dates.length===0){ $('#dailyTable').classList.add('hidden'); $('#dailyEmpty').classList.remove('hidden'); $('#dailyChips').innerHTML=''; currentSelectedReportDate=''; return; }
  $('#dailyTable').classList.remove('hidden'); $('#dailyEmpty').classList.add('hidden');
  if(!currentSelectedReportDate || !map[currentSelectedReportDate]) currentSelectedReportDate=dates[0];
  dates.forEach(function(d){
    var b=document.createElement('button'); b.className='tab'+(d===currentSelectedReportDate?' active':''); b.textContent=formatDateLabel(d); b.title=d;
    b.addEventListener('click', function(){ currentSelectedReportDate=d; [].forEach.call(tabs.querySelectorAll('.tab'), function(t){t.classList.remove('active');}); b.classList.add('active'); renderDailyReport(code,d); });
    tabs.appendChild(b);
  });
  renderDailyReport(code,currentSelectedReportDate);
}
function renderDailyReport(code,dateStr){
  var cls=state.classes[code]; var map=buildDailyMap(cls); var day=map[dateStr]||{byStudent:{}, totals:{neg:0,pos:0,absentCount:0}};
  $('#dailyChips').innerHTML='<span class="chip">Turma: <b>'+(cls.name||cls.code)+'</b></span>'
                            +'<span class="chip">Data: <b>'+(dateStr||'—')+'</b></span>'
                            +'<span class="chip">Negativos: <b>'+(day.totals.neg||0)+'</b></span>'
                            +'<span class="chip">Positivos: <b>'+(day.totals.pos||0)+'</b></span>'
                            +'<span class="chip">Faltas: <b>'+(day.totals.absentCount||0)+'</b></span>';
  var tbody=$('#dailyTable tbody'); tbody.innerHTML='';
  var names=Object.keys(cls.students||{}).sort(function(a,b){return a.localeCompare(b,'pt-BR');});
  names.forEach(function(nm){
    var st=day.byStudent[nm]||{neg:0,pos:0,absent:false};
    var tr=document.createElement('tr'); tr.innerHTML='<td>📘 '+nm+'</td><td>'+(st.neg||0)+'</td><td>'+(st.pos||0)+'</td><td>'+(st.absent?'Sim':'')+'</td>';
    tbody.appendChild(tr);
  });
}
function renderAccumReport(code){
  var cls=state.classes[code]; var tbody=$('#accumTable tbody'); tbody.innerHTML='';
  Object.keys(cls.students||{}).sort(function(a,b){return a.localeCompare(b,'pt-BR');}).forEach(function(name){
    var s=cls.students[name]||{}; var neg=n((s.totals||{}).neg); var pos=n((s.totals||{}).pos); var perc=computeAproveitamento(pos,neg);
    var tr=document.createElement('tr'); tr.innerHTML='<td>📘 '+name+'</td><td>'+neg+'</td><td>'+pos+'</td><td>'+perc.toFixed(0)+'%</td>';
    tbody.appendChild(tr);
  });
}
$('#btnLoadReport').addEventListener('click', function(){
  var code=$('#reportClassCode').value.trim(); if(!code) return;
  if(!state.classes[code]){ alert('Turma não encontrada.'); return; }
  currentViewCode=code; renderDateTabs(code); renderAccumReport(code);
});
$('#tabDaily').addEventListener('click', function(){ this.classList.add('active'); $('#tabAccum').classList.remove('active'); $('#dailyPane').classList.remove('hidden'); $('#accumPane').classList.add('hidden'); });
$('#tabAccum').addEventListener('click', function(){ this.classList.add('active'); $('#tabDaily').classList.remove('active'); $('#accumPane').classList.remove('hidden'); $('#dailyPane').classList.add('hidden'); });
$('#btnExportDaily').addEventListener('click', function(){ var code=$('#reportClassCode').value.trim()||currentViewCode; if(!code||!currentSelectedReportDate) return; exportDailyCSV(code,currentSelectedReportDate); });
$('#btnExportAccum').addEventListener('click', function(){ var code=$('#reportClassCode').value.trim()||currentViewCode; if(!code) return; exportAccumCSV(code); });
function downloadCSV(name,text){ var b=new Blob([text],{type:'text/csv;charset=utf-8;'}); var u=URL.createObjectURL(b); var a=document.createElement('a'); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }
function exportDailyCSV(code,dateStr){
  var cls=state.classes[code]; if(!cls) return; var map=buildDailyMap(cls); var day=map[dateStr]||{byStudent:{}, totals:{neg:0,pos:0,absentCount:0}};
  var names=Object.keys(cls.students||{}).sort(function(a,b){return a.localeCompare(b,'pt-BR');});
  var csv='Turma,'+(cls.name||cls.code)+'\nData,'+dateStr+'\n\nAluno,Negativos (dia),Positivos (dia),Faltou?\n';
  names.forEach(function(nm){ var st=day.byStudent[nm]||{neg:0,pos:0,absent:false}; csv+='"'+nm+'",'+(st.neg||0)+','+(st.pos||0)+','+(st.absent?'Sim':'')+'\n'; });
  csv+='\nResumo,,,\nTotal Negativos,'+(day.totals.neg||0)+'\nTotal Positivos,'+(day.totals.pos||0)+'\nFaltas,'+(day.totals.absentCount||0)+'\n';
  downloadCSV('relatorio-dia-'+code+'-'+(dateStr||'sem_data')+'.csv',csv);
}
function exportAccumCSV(code){
  var cls=state.classes[code]; if(!cls) return; var csv='Turma,'+(cls.name||cls.code)+'\n\nAluno,Negativos (total),Positivos (total),Aproveitamento (%)\n';
  Object.keys(cls.students||{}).sort(function(a,b){return a.localeCompare(b,'pt-BR');}).forEach(function(nm){
    var s=cls.students[nm]||{}; var neg=n((s.totals||{}).neg); var pos=n((s.totals||{}).pos); var perc=computeAproveitamento(pos,neg).toFixed(0);
    csv+='"'+nm+'",'+neg+','+pos+','+perc+'\n';
  });
  downloadCSV('relatorio-acumulado-'+code+'.csv',csv);
}

/* ===== Portal do aluno ===== */
function classAndStudent(code,name){
  var cls=state.classes[code]; if(!cls) return [null,null];
  var entry=null; Object.keys(cls.students||{}).forEach(function(nm){
    if(nm.trim().toLowerCase()===name.trim().toLowerCase()) entry={key:nm, data:cls.students[nm]};
  });
  return [cls, entry];
}
function buildStudentDays(student){
  var map={}; (student.history||[]).forEach(function(h){
    if(!h.date) return;
    if(!map[h.date]) map[h.date]={date:h.date,neg:0,pos:0,absent:false};
    if(h.absent){ map[h.date].absent=true; }
    if(typeof h.neg==='number') map[h.date].neg+=h.neg;
    var p=(h.applied&&h.applied.posAdded)||0; if(p) map[h.date].pos+=p;
  });
  var days=Object.keys(map).map(function(k){return map[k];}).sort(function(a,b){return a.date.localeCompare(b.date);});
  days.forEach(function(d){ d.percDay = d.pos>0 ? Math.max(0, Math.min(100, ((d.pos - d.neg)/d.pos)*100 )) : 0; });
  return days;
}
function setProgressBar(el, percent){
  var bar=el.querySelector('.bar'), label=el.querySelector('.label');
  bar.style.width=Math.round(percent)+'%'; label.textContent=Math.round(percent)+'%';
  el.classList.remove('bad','ok','good');
  if(percent<40) el.classList.add('bad'); else if(percent<70) el.classList.add('ok'); else el.classList.add('good');
}
function renderStudentPortal(code, rawName){
  var pair=classAndStudent(code, rawName); var cls=pair[0], stObj=pair[1];
  var wrap=$('#studentWrap'), empty=$('#stEmpty');
  if(!cls || !stObj){ wrap.classList.add('hidden'); empty.classList.remove('hidden'); empty.textContent='Não encontrei essa turma/aluno. Verifique o nome como cadastrado.'; return; }
  var name=stObj.key, st=stObj.data;
  $('#stName').textContent=name; $('#stClass').textContent=cls.name||cls.code;
  var totPos=n((st.totals||{}).pos), totNeg=n((st.totals||{}).neg); var percAccum=computeAproveitamento(totPos, totNeg); setProgressBar($('#stProgress'), percAccum);
  var days=buildStudentDays(st); var tabs=$('#stDateTabs'); tabs.innerHTML=''; var dailyBody=$('#stDailyBody'); dailyBody.innerHTML=''; var chips=$('#stDailyChips');
  if(days.length===0){ wrap.classList.remove('hidden'); empty.classList.remove('hidden'); $('#stDailyWrap').classList.add('hidden'); return; }
  $('#stDailyWrap').classList.remove('hidden'); empty.classList.add('hidden'); wrap.classList.remove('hidden');
  var trend='—'; if(days.length>=2){ var a=days[days.length-2].percDay, b=days[days.length-1].percDay; trend=(b>a)?('⬆️ +'+Math.round(b-a)+'%'):(b<a)?('⬇️ '+Math.round(b-a)+'%'):'→ 0%'; } $('#stTrend').textContent=trend;
  var selected=days[days.length-1].date;
  function paintDay(date){
    var d=days.find(function(x){return x.date===date;}); if(!d) return;
    chips.innerHTML = '<span class="chip">Data: <b>'+date+'</b></span>'
                     +'<span class="chip">Negativos: <b>'+d.neg+'</b></span>'
                     +'<span class="chip">Positivos: <b>'+d.pos+'</b></span>'
                     +'<span class="chip">Faltou: <b>'+(d.absent?'Sim':'Não')+'</b></span>'
                     +'<span class="chip">% do dia: <b>'+Math.round(d.percDay)+'%</b></span>';
    dailyBody.innerHTML='<tr><td>📅 '+date+'</td><td>'+d.neg+'</td><td>'+d.pos+'</td><td>'+(d.absent?'Sim':'Não')+'</td><td>'+Math.round(d.percDay)+'%</td></tr>';
  }
  days.forEach(function(d){
    var b=document.createElement('button'); b.className='tab'+(d.date===selected?' active':''); b.textContent=formatDateLabel(d.date); b.title=d.date;
    b.addEventListener('click', function(){ selected=d.date; [].forEach.call(tabs.querySelectorAll('.tab'), function(t){t.classList.remove('active');}); b.classList.add('active'); paintDay(selected); });
    tabs.appendChild(b);
  });
  paintDay(selected);
}
$('#btnLoadStudent').addEventListener('click', function(){
  var code=$('#studentClassCode').value.trim(); var name=$('#studentName').value.trim();
  if(!code||!name){ alert('Preencha turma e seu nome.'); return; } renderStudentPortal(code,name);
});

/* ===== Inicializa abas ===== */
(function start(){
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initTopTabs); }
  else { initTopTabs(); }
})();
</script>
</body>
</html>
